var le=Object.defineProperty;var pe=(S,_,M)=>_ in S?le(S,_,{enumerable:!0,configurable:!0,writable:!0,value:M}):S[_]=M;var y=(S,_,M)=>(pe(S,typeof _!="symbol"?_+"":_,M),M);(function(){"use strict";var S=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},_={exports:{}};(function(a){(function(s,r){a.exports?a.exports=r():s.bioseq=r()})(typeof self!="undefined"?self:S,function(){var s={};return s.makeIntArray=function(r,n,e){var o=n<=16?new Int16Array(r):new Int32Array(r),f=n<=8?new Int8Array(r):o,t=typeof Int8Array!="undefined",i=t?f:[];if(!t||e!==0&&e!==void 0)for(var u=0;u<r;u++)i[u]=e;return i},s.makeAlphabetMap=function(r,n){for(var e=s.makeIntArray(256,8,n),o=r.toLowerCase(),f=0;f<r.length;f++)e[r.charCodeAt(f)]=f,e[o.charCodeAt(f)]=f;return e},s.nt5=s.makeAlphabetMap("ACGT",4),s.nac=s.makeAlphabetMap("ACGTURYMKWSBDHVN",16),s.aac=s.makeAlphabetMap("ARNDCQEGHILKMFPSTWYVBZX",32),s.align=function(r,n,e,o,f,t,i){typeof e=="undefined"&&(e=!0),typeof o=="undefined"&&(o=[1,-1]),typeof f=="undefined"&&(f=[-1,-1]),i==null&&(i=s.nt5);var u=s.bsg_enc_seq(r,i),c=s.gen_query_profile(n,o,i),l=c[0].length,A=l>u.length?l:u.length;t=t==null||t<0?A:t;var d=u.reference>l?u.reference-l:l-u.reference;t=t>d?t:d;var q,m;typeof f=="number"?(q=0,m=f>0?f:-f):(q=f[0]>0?f[0]:-f[0],m=f[1]>0?f[1]:-f[1]);var b=q+m,C=[],P=[],K=[],W,D=0,X=-1,V=-1;if(e)for(var h=0;h<=l;++h)C[h]=P[h]=0;else{C[0]=0,P[0]=-b-q;for(var h=1;h<=l;++h)h>=t?C[h]=P[h]=Number.NEGATIVE_INFINITY:(C[h]=-(b+m*(h-1)),P[h]=-(b+b+m*h))}for(var p=0;p<u.length;++p){var k=0,I=0,O=0,Y=-1,$,fe=c[u[p]];$=K[p]=[];var F=p>t?p-t:0,U=p+t+1<l?p+t+1:l;e||(k=F>0?Number.NEGATIVE_INFINITY:-(b+m*p),I=F>0?Number.NEGATIVE_INFINITY:-(b+b+m*p));for(var h=F;h<U;++h){var N=P[h],g=C[h],R;C[h]=k,g+=fe[h],R=g>N?0:1,g=g>N?g:N,R=g>I?R:2,g=g>I?g:I,R=!e||g>0?R:1<<6,k=g,Y=O>g?Y:h,O=O>g?O:g,g-=b,g=!e||g>0?g:0,N-=m,R|=N>g?1<<2:0,N=N>g?N:g,P[h]=N,I-=m,R|=I>g?2<<4:0,I=I>g?I:g,$[h]=R}C[U]=k,P[U]=e?0:Number.NEGATIVE_INFINITY,O>D&&(D=O,X=p,V=Y)}if(e&&D==0)return null;W=e?D:C[l];function T(E,Z,ee){E.length==0||Z!=(E[E.length-1]&15)?E.push(ee<<4|Z):E[E.length-1]+=ee<<4}var v=[],w,G=0,p,x,j=0;for(e?(p=X,x=V,V!=l-1&&T(v,4,l-1-V)):(p=u.length-1,x=(p+t+1<l?p+t+1:l)-1);p>=0&&x>=0&&(w=K[p][x-(p>t?p-t:0)],G=w>>(G<<1)&3,!(G==0&&w>>6));)G==0&&(G=w&3),G==0?(T(v,0,1),--p,--x):G==1?(T(v,2,1),--p):(T(v,1,1),--x);e?(x>=0&&T(v,4,x+1),j=p+1):(p>=0&&T(v,2,p+1),x>=0&&T(v,1,x+1));for(var p=0;p<v.length>>1;++p)w=v[p],v[p]=v[v.length-1-p],v[v.length-1-p]=w;return{score:W,position:j,CIGAR:v}},s.gen_score_matrix=function(r,n,e){var o=[];e>0&&(e=-e);for(var f=0;f<r-1;++f){o[f]=[];for(var t=0;t<r-1;++t)o[f][t]=f==t?n:e;o[f][t]=0}o[r-1]=[];for(var t=0;t<r;++t)o[r-1][t]=0;return o},s.gen_query_profile=function(r,n,e){var o=typeof r=="string"?s.bsg_enc_seq(r,e):r,f=[],t;if(n.length>=2&&typeof n[0]=="number"&&typeof n[1]=="number"){if(e==null)return null;var i=typeof e=="number"?e:e[e.length-1]+1;t=s.gen_score_matrix(i,n[0],n[1])}else t=n;for(var u=0;u<t.length;++u){var c,l=t[u];c=f[u]=[];for(var A=0;A<o.length;++A)c[A]=l[o[A]]}return f},s.bsg_enc_seq=function(r,n){n==null&&(n=s.nt5);for(var e=new Array(r.length),o=0;o<r.length;++o)e[o]=n[r.charCodeAt(o)];return e},s.cigar2str=function(r){for(var n=[],e=0;e<r.length;++e)n.push((r[e]>>4).toString()+"MIDNSHP=XB".charAt(r[e]&15));return n.join()},s.cigar2gaps=function(r,n,e,o,f){for(var t="",i="",u=0,c=e,l=0;l<o.length;++l){var A=o[l]&15,d=o[l]>>4;A==0?(t+=n.substr(u,d),i+=r.substr(c,d),u+=d,c+=d):A==1?(f||(t+=n.substr(u,d),i+="-".repeat(d)),u+=d):A==2?(t+="-".repeat(d),i+=r.substr(c,d),c+=d):A==4&&(u+=d)}return[i,t]},s})})(_);var M=_.exports;class te{constructor(s="",r="",n="",e="",o="",f="",t){y(this,"name");y(this,"gene");y(this,"gRNA_PAM");y(this,"barcode_L");y(this,"barcode_R");y(this,"group");y(this,"sumup");y(this,"ref");y(this,"reverse");y(this,"identification");this.name=s,this.gene=r,this.gRNA_PAM=n,this.barcode_L=e,this.barcode_R=o,this.group=f,t&&(this.identification=t)}sumUp(s){let r=0;for(const n in s)r+=s[n];this.sumup=r}getRef(s){let r=s.toUpperCase(),n=!1;r.indexOf(this.gRNA_PAM)==-1&&(r=H(s),n=!0);try{const e=r.indexOf(this.gRNA_PAM);this.ref=r.slice(e>70?e-70:0,e+70+this.gRNA_PAM.length),this.reverse=n}catch(e){console.error(e)}}}function re(a,s){const r={sample:a.sample,haplotype:[]};a.sample.getRef(s);for(const n in a.haplotype){const e=a.sample.reverse?H(n):n,o=M.align(a.sample.ref,e,!1);r.haplotype.push({result:M.cigar2gaps(a.sample.ref,e,o.position,o.CIGAR),count:a.haplotype[n]})}return r}function H(a){return a.split("").reverse().map(s=>({A:"T",T:"A",G:"C",C:"G",a:"t",t:"a",c:"g",g:"c"})[s]).join("")}function B(a,s){const r=[];let n;for(;(n=a.exec(s))!==null;){let e=0;for(const o of r)e+=o.length;r.push({index:n.index-e,length:n[0].length})}return r}class z{constructor(s,r,n,e=30){y(this,"reference");y(this,"query");y(this,"gRNA_PAM");y(this,"clean_reference");y(this,"gRNA_PAM_pos");y(this,"windowSize");this.reference=s,this.query=r,this.gRNA_PAM=n,this.windowSize=e,this.clean_reference=this.reference.replace(/(A|T|C|G|a|t|c|g)-+(?=(A|T|C|G|a|t|c|g))/g,"$1"),this.gRNA_PAM_pos=this.clean_reference.indexOf(this.gRNA_PAM)}multi_result(){const s={query:"",insertions:[]};s.query=this.remove_insertion().slice(this.gRNA_PAM_pos-this.windowSize,this.gRNA_PAM_pos+this.gRNA_PAM.length+this.windowSize);const r=this.get_insertion();let n=0;for(;n<r.length;)r[n].index-=this.gRNA_PAM_pos-this.windowSize,r[n].index<0||r[n].index>this.gRNA_PAM.length+100?r.splice(n,1):n++;return s.insertions=r,s}remove_insertion(){const s=B(/(A|T|C|G|a|t|c|g)-+(?=(A|T|C|G|a|t|c|g))/g,this.reference),r=this.lookbehindAdjust(s),n=this.query.split("");for(const e of r)n.splice(e.index,e.length);return n.join("")}get_insertion(){const s=B(/(A|T|C|G|a|t|c|g)-+(?=(A|T|C|G|a|t|c|g))/g,this.reference),r=this.lookbehindAdjust(s),n=this.query.split(""),e=[];for(const o of r){const f=n.splice(o.index,o.length);e.push({index:o.index,sequence:f.join("")})}return e}lookbehindAdjust(s){for(const r of s)r.index+=1,r.length-=1;return s}}function ne(a,s=30){const r=[];for(const n of a){let e=n.sample.ref;const o={sample:n.sample,res:[]},f=n.sample.gRNA_PAM;n.sample.ref=e.slice(e.indexOf(f)-s,e.indexOf(f)+f.length+s),e=n.sample.ref;for(const t of n.haplotype){const u=new z(t.result[0],t.result[1],f).multi_result();o.res.push({query:u.query,count:t.count,insertions:u.insertions})}for(const t of o.res){let i=0,u=0;for(let c=0;c<e.length-1;c++)t.query[c]==="-"?u+=1:t.query[c]!==e[c]&&t.query[c]!=="-"&&e[c]!=="-"&&(t.query=t.query.slice(0,c)+t.query[c].toLowerCase()+t.query.slice(c+1),i+=1);(e.length-u<i*2||i>5)&&o.res.splice(o.res.indexOf(t),1)}o.res=o.res.map(t=>{let i=t.count;if(t.insertions.length===0)for(const u of o.res)t.query===u.query&&u.insertions.length===0&&(i+=u.count);return i!==t.count&&(i-=t.count),{query:t.query,count:i,insertions:t.insertions}}).filter((t,i,u)=>i===u.findIndex(c=>JSON.stringify(c)===JSON.stringify(t))),o.res.sort((t,i)=>t.count<i.count?1:t.count>i.count?-1:0),o.sample.sumup=o.res.reduce((t,i)=>(t+=i.count,t),0),r.push(o)}return r}const Q=a=>a[0].map((s,r)=>a.map(n=>n[r]));function J(a,s=!1){if(a.length==1)return 0;const r=a.reduce((n,e)=>n+e,0)/a.length;return Math.sqrt(a.reduce((n,e)=>n.concat((e-r)**2),[]).reduce((n,e)=>n+e,0)/(a.length-(s?0:1)))}function L(a,s,r,n=30){const e=a.slice(a.indexOf(s)-n,a.indexOf(s)).split("").concat(s.split("").map(o=>({value:o,textStyle:{color:"red"}}))).concat(a.slice(a.indexOf(s)+s.length,a.indexOf(s)+s.length+n).split(""));return r.length>1?Q(r).reduce((o,f,t)=>{const i=f.reduce((c,l)=>c+l,0)/f.length||0,u=J(f,!0)/Math.sqrt(f.length);return o.bar.push(i),o.errorbar.push([t,i+u,u>i?0:i-u]),o},{xaxis:e,bar:[],errorbar:[],state:"success"}):Q(r).reduce((o,f)=>(o.bar.push(f.reduce((t,i)=>t+i,0)/f.length||0),o),{xaxis:e,bar:[],errorbar:void 0,state:"warning"})}function se(a){const s=a[0].sample.gRNA_PAM,r=a[0].sample.ref,n=a.map(o=>{const f=o.sample.sumup,t=[...Array(100+s.length)].map(()=>0);for(const i of o.res){const u=new z(r,i.query,s);for(let c=0;c<r.length;c++)u.multi_result().query[c]==="-"&&(t[c]+=i.count/f*100)}return t}),e=L(r,s,n);return e.type="Deletion",e}function oe(a){const s=a[0].sample.gRNA_PAM,r=a[0].sample.ref,n=a.map(o=>{const f=o.sample.sumup,t=[...Array(100+s.length)].map(()=>0);for(const i of o.res){const u=new z(r,i.query,s);for(let c=0;c<r.length;c++)u.multi_result().query[c].match(/(a|t|c|g)/)&&(t[c]+=i.count/f*100)}return t}),e=L(r,s,n);return e.type="mutation",e}function ie(a){const s=a[0].sample.gRNA_PAM,r=a[0].sample.ref,n=a.map(o=>{const f=o.sample.sumup,t=[...Array(100+s.length)].map(i=>0);for(const i of o.res)for(const u of i.insertions)t[u.index]+=i.count/f*100;return t}),e=L(r,s,n);return e.type="Insertion",e}function ue(a){const s=[],r=a[0].sample.gRNA_PAM,n=a[0].sample.ref;for(const u of a){const c=[];for(const l of u.res){const A=new z(n,l.query,r);let d=0;for(let q=0;q<A.multi_result().query.length;q++)A.multi_result().query[q]==="-"&&(d+=1,A.multi_result().query[q+1]!=="-"&&(d>20?c.find(m=>m[0]===">20")?c[c.findIndex(m=>m[0]===">20")][1]+=l.count:c.push([">20",l.count]):c.find(m=>m[0]===d.toString())?c[c.findIndex(m=>m[0]===d.toString())][1]+=l.count:c.push([d.toString(),l.count]),d=0))}s.push(c)}const e=[],o=[],f=[],t=[];for(const u of s)u.sort().sort((c,l)=>parseInt(c[0])-parseInt(l[0])),u.map(c=>{t.find(l=>l[0]===c[0])?t[t.findIndex(l=>l[0]===c[0])].push(c[1]):(o.push(c[0]),t.push(c))});let i=0;o.sort().sort((u,c)=>parseInt(u)-parseInt(c)),t.sort().sort((u,c)=>parseInt(u[0])-parseInt(c[0]));for(const u of t){const c=u.slice(1).reduce((A,d)=>A+d,0)/s.length||0;e.push(c);const l=J(u.slice(1))/Math.sqrt(s.length);f.push([i,c+l,l>c?0:c-l]),i++}return a.length>1?{type:"Deletion size",xaxis:o,bar:e,errorbar:f,state:"success"}:{type:"Deletion size",xaxis:o,bar:e,errorbar:void 0,state:"success"}}function ce(a){const s=[];for(const t of a){const i=[];for(const u of t.res)for(const c of u.insertions)c.sequence.length>20?i.find(l=>l[0]===">20")?i[i.findIndex(l=>l[0]===">20")][1]+=u.count:i.push([">20",u.count]):i.find(l=>l[0]===c.sequence.length.toString())?i[i.findIndex(l=>l[0]===c.sequence.length.toString())][1]+=u.count:i.push([c.sequence.length.toString(),u.count]);s.push(i)}const r=[],n=[],e=[],o=[];for(const t of s)t.sort(),t.sort((i,u)=>parseInt(i[0])-parseInt(u[0])),t.map(i=>{o.find(u=>u[0]===i[0])?o[o.findIndex(u=>u[0]===i[0])].push(i[1]):(n.push(i[0]),o.push(i))});let f=0;n.sort(),n.sort((t,i)=>parseInt(t)-parseInt(i)),o.sort(),o.sort((t,i)=>parseInt(t[0])-parseInt(i[0]));for(const t of o){const i=t.slice(1).reduce((c,l)=>c+l,0)/s.length||0;r.push(i);const u=J(t.slice(1))/Math.sqrt(s.length);e.push([f,i+u,u>i?0:i-u]),f++}return a.length>1?{type:"Insertion size",xaxis:n,bar:r,errorbar:e,state:"success"}:{type:"Insertion size",xaxis:n,bar:r,errorbar:void 0,state:"success"}}function ae(a){return a.map(r=>({sample:r.sample,res:r.res.filter(n=>n.count>r.sample.sumup*1e-4&&n.count>3)})),{groupsvgjson:a[0].sample.group,deletionChart:se(a),mutationChart:oe(a),deletionSizeChart:ue(a),multialignChart:a,insertionChart:ie(a),insertionSizeChart:ce(a)}}self.onmessage=({data:{type:a,samples:s}})=>{switch(a){case"group":{const r=JSON.parse(s),n=ae(r);self.postMessage({type:"group",result:{multi_result:r,chart_data:n}});break}case"all":{const r=JSON.parse(s),n=ne(r.map(e=>{const o=new te(e.name,e.gene,e.gRNA_PAM.toUpperCase(),e.barcode_L,e.barcode_R,e.group);return o.sumUp(e.reads),o.getRef(e.targetSeq),re({sample:o,haplotype:e.reads},e.targetSeq)}));self.postMessage({type:"all",result:{multi_result:n}})}}}})();
