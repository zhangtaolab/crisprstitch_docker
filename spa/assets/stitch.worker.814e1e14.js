var Ee=Object.defineProperty;var Ge=(l,g,C)=>g in l?Ee(l,g,{enumerable:!0,configurable:!0,writable:!0,value:C}):l[g]=C;var f=(l,g,C)=>(Ge(l,typeof g!="symbol"?g+"":g,C),C);(function(){"use strict";var l=Uint8Array,g=Uint16Array,C=Int32Array,X=new l([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Z=new l([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),pe=new l([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),j=function(i,t){for(var e=new g(31),r=0;r<31;++r)e[r]=t+=1<<i[r-1];for(var s=new C(e[30]),r=1;r<30;++r)for(var o=e[r];o<e[r+1];++o)s[o]=o-e[r]<<5|r;return{b:e,r:s}},ee=j(X,2),te=ee.b,ge=ee.r;te[28]=258,ge[258]=28;for(var de=j(Z,0),we=de.b,_=new g(32768),h=0;h<32768;++h){var $=(h&43690)>>1|(h&21845)<<1;$=($&52428)>>2|($&13107)<<2,$=($&61680)>>4|($&3855)<<4,_[h]=(($&65280)>>8|($&255)<<8)>>1}for(var F=function(i,t,e){for(var r=i.length,s=0,o=new g(t);s<r;++s)i[s]&&++o[i[s]-1];var u=new g(t);for(s=1;s<t;++s)u[s]=u[s-1]+o[s-1]<<1;var v;if(e){v=new g(1<<t);var p=15-t;for(s=0;s<r;++s)if(i[s])for(var w=s<<4|i[s],a=t-i[s],n=u[i[s]-1]++<<a,c=n|(1<<a)-1;n<=c;++n)v[_[n]>>p]=w}else for(v=new g(r),s=0;s<r;++s)i[s]&&(v[s]=_[u[i[s]-1]++]>>15-i[s]);return v},k=new l(288),h=0;h<144;++h)k[h]=8;for(var h=144;h<256;++h)k[h]=9;for(var h=256;h<280;++h)k[h]=7;for(var h=280;h<288;++h)k[h]=8;for(var re=new l(32),h=0;h<32;++h)re[h]=5;var be=F(k,9,1),me=F(re,5,1),I=function(i){for(var t=i[0],e=1;e<i.length;++e)i[e]>t&&(t=i[e]);return t},m=function(i,t,e){var r=t/8|0;return(i[r]|i[r+1]<<8)>>(t&7)&e},R=function(i,t){var e=t/8|0;return(i[e]|i[e+1]<<8|i[e+2]<<16)>>(t&7)},ie=function(i){return(i+7)/8|0},P=function(i,t,e){(t==null||t<0)&&(t=0),(e==null||e>i.length)&&(e=i.length);var r=new l(e-t);return r.set(i.subarray(t,e)),r},ye=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],d=function(i,t,e){var r=new Error(t||ye[i]);if(r.code=i,Error.captureStackTrace&&Error.captureStackTrace(r,d),!e)throw r;return r},qe=function(i,t,e,r){var s=i.length,o=r?r.length:0;if(!s||t.f&&!t.l)return e||new l(0);var u=!e||t.i!=2,v=t.i;e||(e=new l(s*3));var p=function(ce){var ue=e.length;if(ce>ue){var ve=new l(Math.max(ue*2,ce));ve.set(e),e=ve}},w=t.f||0,a=t.p||0,n=t.b||0,c=t.l,L=t.d,z=t.m,M=t.n,O=s*8;do{if(!c){w=m(i,a,1);var Y=m(i,a+1,3);if(a+=3,Y)if(Y==1)c=be,L=me,z=9,M=5;else if(Y==2){var H=m(i,a,31)+257,se=m(i,a+10,15)+4,ae=H+m(i,a+5,31)+1;a+=14;for(var T=new l(ae),J=new l(19),b=0;b<se;++b)J[pe[b]]=m(i,a+b*3,7);a+=se*3;for(var ne=I(J),De=(1<<ne)-1,_e=F(J,ne,1),b=0;b<ae;){var oe=_e[m(i,a,De)];a+=oe&15;var q=oe>>4;if(q<16)T[b++]=q;else{var x=0,D=0;for(q==16?(D=3+m(i,a,3),a+=2,x=T[b-1]):q==17?(D=3+m(i,a,7),a+=3):q==18&&(D=11+m(i,a,127),a+=7);D--;)T[b++]=x}}var fe=T.subarray(0,H),y=T.subarray(H);z=I(fe),M=I(y),c=F(fe,z,1),L=F(y,M,1)}else d(1);else{var q=ie(a)+4,B=i[q-4]|i[q-3]<<8,N=q+B;if(N>s){v&&d(0);break}u&&p(n+B),e.set(i.subarray(q,N),n),t.b=n+=B,t.p=a=N*8,t.f=w;continue}if(a>O){v&&d(0);break}}u&&p(n+131072);for(var Ie=(1<<z)-1,Re=(1<<M)-1,K=a;;K=a){var x=c[R(i,a)&Ie],A=x>>4;if(a+=x&15,a>O){v&&d(0);break}if(x||d(2),A<256)e[n++]=A;else if(A==256){K=a,c=null;break}else{var he=A-254;if(A>264){var b=A-257,S=X[b];he=m(i,a,(1<<S)-1)+te[b],a+=S}var Q=L[R(i,a)&Re],V=Q>>4;Q||d(3),a+=Q&15;var y=we[V];if(V>3){var S=Z[V];y+=R(i,a)&(1<<S)-1,a+=S}if(a>O){v&&d(0);break}u&&p(n+131072);var W=n+he;if(n<y){var le=o-y,Ue=Math.min(y,W);for(le+n<0&&d(3);n<Ue;++n)e[n]=r[le+n]}for(;n<W;n+=4)e[n]=e[n-y],e[n+1]=e[n+1-y],e[n+2]=e[n+2-y],e[n+3]=e[n+3-y];n=W}}t.l=c,t.p=K,t.b=n,t.f=w,c&&(w=1,t.m=z,t.d=L,t.n=M)}while(!w);return n==e.length?e:P(e,0,n)},ze=new l(0),$e=function(i){(i[0]!=31||i[1]!=139||i[2]!=8)&&d(6,"invalid gzip data");var t=i[3],e=10;t&4&&(e+=(i[10]|i[11]<<8)+2);for(var r=(t>>3&1)+(t>>4&1);r>0;r-=!i[e++]);return e+(t&2)},U=function(){function i(t,e){typeof t=="function"&&(e=t,t={}),this.ondata=e;var r=t&&t.dictionary&&t.dictionary.subarray(-32768);this.s={i:0,b:r?r.length:0},this.o=new l(32768),this.p=new l(0),r&&this.o.set(r)}return i.prototype.e=function(t){if(this.ondata||d(5),this.d&&d(4),!this.p.length)this.p=t;else if(t.length){var e=new l(this.p.length+t.length);e.set(this.p),e.set(t,this.p.length),this.p=e}},i.prototype.c=function(t){this.s.i=+(this.d=t||!1);var e=this.s.b,r=qe(this.p,this.s,this.o);this.ondata(P(r,e,this.s.b),this.d),this.o=P(r,this.s.b-32768),this.s.b=this.o.length,this.p=P(this.p,this.s.p/8|0),this.s.p&=7},i.prototype.push=function(t,e){this.e(t),this.c(e)},i}(),Le=function(){function i(t,e){this.v=1,this.r=0,U.call(this,t,e)}return i.prototype.push=function(t,e){if(U.prototype.e.call(this,t),this.r+=t.length,this.v){var r=this.p.subarray(this.v-1),s=r.length>3?$e(r):4;if(s>r.length){if(!e)return}else this.v>1&&this.onmember&&this.onmember(this.r-r.length);this.p=r.subarray(s),this.v=0}U.prototype.c.call(this,e),this.s.f&&!this.s.l&&(this.v=ie(this.s.p)+9,this.s={i:0},this.o=new l(0),this.p.length&&this.push(new l(0),e))},i}(),Ce=typeof TextDecoder!="undefined"&&new TextDecoder,xe=0;try{Ce.decode(ze,{stream:!0}),xe=1}catch{}class Ae{constructor(t,e){f(this,"file");f(this,"reader");f(this,"buffer");f(this,"eof");f(this,"gzipped");f(this,"filesize");f(this,"fpos");f(this,"lines");f(this,"gzip");this.file=t,this.reader=t.stream().getReader(),this.filesize=t.size,this.fpos=0,this.buffer="",this.eof=!1,this.gzipped=e,this.lines=0,this.gzip=new Le}readline(t){const e=this.buffer.indexOf(`
`);if(e===-1)if(this.eof){const r=this.buffer;this.buffer="",t(r)}else this._getchunk().then(()=>this.readline(t));else{let r;this.buffer[e-1]==="\r"?r=this.buffer.slice(0,e-1):r=this.buffer.slice(0,e),this.lines+=1,this.buffer=this.buffer.slice(e+1),t(r)}}async _getchunk(){var r;const{done:t,value:e}=await this.reader.read();return this.fpos+=(r=e==null?void 0:e.length)!=null?r:0,new Promise(s=>{t&&(this.eof=!0,s()),this.gzipped?(this.gzip.ondata=o=>{this.buffer+=new TextDecoder().decode(o),s()},this.gzip.push(e)):(this.buffer+=new TextDecoder().decode(e),s())})}}class Fe{constructor(t){f(this,"file");f(this,"filereader");f(this,"gzipped");this.file=t,this.gzipped=!!this.file.name.match(/(\.gz)$/),this.filereader=new Ae(this.file,this.gzipped)}async*[Symbol.asyncIterator](){let t=0;const e={0:"",1:""};for(;!this.filereader.eof;){const r=await new Promise(s=>this.filereader.readline(o=>s(o)));r!=`
`&&(t<1?(e[t]=r.trim(),t+=1):t===1&&(e[t]=r.trim().toUpperCase(),t=0,yield new G(e[0],e[1])))}}}class E extends Fe{constructor(e,r){super(e);f(this,"readingPgCallback");this.readingPgCallback=r}async*[Symbol.asyncIterator](){let e=0;const r={0:"",1:"",2:"",3:""};let s=0;for(;!this.filereader.eof;){const o=await new Promise(v=>this.filereader.readline(p=>v(p))),u=this.filereader.fpos/this.file.size;o!=`
`&&(e<3?(r[e]=o.trim(),e+=1):e===3&&(r[e]=o.trim(),e=0,yield new G(r[0],r[1],r[3]))),u!==s&&this.readingPgCallback&&(this.readingPgCallback(u),s=u)}}}class G{constructor(t,e,r){f(this,"header");f(this,"seq");f(this,"qual");f(this,"type");f(this,"seqArray");this.header=t.replace(/^@+|\n$|^>+/g,""),this.seq=e,this.seqArray=e.split(""),this.qual=r,r?this.type="fastq":this.type="fasta"}stringify(){if(this.type==="fasta")return`>${this.header}
${this.seq}
`;if(this.type==="fastq")return`@${this.header}
${this.seq}
+${this.header}
${this.qual}`}length(){return this.seq.length}complement(t){return{A:"T",T:"A",G:"C",C:"G",R:"Y",Y:"R",a:"t",t:"a",c:"g",g:"c",r:"y",y:"r"}[t]}revcomp(){return this.seq.split("").reverse().map(this.complement).join("")}rqual(){return this.qual?this.qual.split("").reverse().join(""):"N"}}async function*ke(...i){async function*t(e){for await(const r of e)yield r}for(i=i.map(t);;){const e=await Promise.all(i.map(r=>r.next()));if(e.some(r=>r.done))return;yield e.map(r=>r.value)}}async function Me(i,t,e){for await(const r of new E(i,e))t(r.seq)}async function Te(i,t,e){let[r,s]=[0,0];const o=new Date().getTime();for await(const v of ke(new E(i.filea,e),new E(i.fileb))){const p=new Se(v[0],v[1],i.barcodeLength);s+=1,p.record&&(r+=1,i.pretty&&(console.log(`>${p.reca.header} (${p.score})`),console.log(p.pretty)),t(p.record.seq))}const u=new Date().getTime()-o;return console.log(`Made ${r} contigs out of ${s} read pairs in ${u/1e3} seconds`),{numcontigs:r,numtotal:s}}class Se{constructor(t,e,r){f(this,"reca");f(this,"recb");f(this,"record");f(this,"pretty");f(this,"score");f(this,"barcodeL");this.reca=t,this.recb=e,this.barcodeL=r,this.pretty="",this.score=0,this.find_overlaps()}originals(){return[this.reca,this.recb]}find_overlaps(t=6){const[e,r]=[this.reca.seq,this.recb.revcomp()];let s=0,o="not found",u="",v="";for(let c=t;c<=Math.min(e.length,r.length);c++){const L=e.slice(-c),z=r.slice(0,c);L===z&&(s=c,o="tail")}if(o==="not found")for(let c=t;c<=Math.min(e.length-this.barcodeL,r.length-this.barcodeL);c++){const L=e.slice(this.barcodeL,c+this.barcodeL),z=r.slice(-c-this.barcodeL,-this.barcodeL);L===z&&(s=c,o="cross")}const p=e,w=this.reca.qual;let a,n;o==="not found"?(a="",n=""):o==="tail"?(a=r.slice(s-r.length),n=this.recb.rqual().slice(s-r.length),u=p+a,v=w+n):(a=r.slice(-this.barcodeL),n=this.recb.rqual().slice(-this.barcodeL),u=p.slice(0,s+this.barcodeL)+a,v=(w==null?void 0:w.slice(0,s+this.barcodeL))+n),o!=="not found"&&(this.pretty=`1:${e+"-".repeat(s-1)}
2:${"-".repeat(s-1)+r}
C:${u}
`,this.record=new G("@"+this.reca.header,u,v))}}class Pe{constructor(t,e){f(this,"files");f(this,"gzipped");f(this,"barcodeLength");this.files=t.sort((r,s)=>r.name.toLowerCase().localeCompare(s.name.toLowerCase())),this.gzipped=!!this.files[0].name.match(/(\.gz)$/),this.barcodeLength=e}saveAsSequence(t,e){if(this.files.length>1)return Te({filea:this.files[0],fileb:this.files[1],barcodeLength:this.barcodeLength},t,e);Me(this.files[0],t,e)}}self.onmessage=({data:{filea:i,fileb:t,barcodeLength:e}})=>{const r=new Pe(t?[i,t]:[i],e);try{const s=r.saveAsSequence(o=>{self.postMessage({type:"seq",result:o})},o=>self.postMessage({type:"progress",result:o}));s&&s.then(o=>{self.postMessage({type:"mergeResult",result:o})})}catch(s){self.postMessage({type:"error",result:s.message})}}})();
